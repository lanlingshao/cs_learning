参考

https://g.yuque.com/u1552873/iwiwt3/wlk5uy

# 注意读写分离带来的数据不⼀致问题

读写分离的⼀个副作⽤是，可能会存在数据不⼀致的情况。原因是，数据库中的数据在主库完成更新后，是异步同步到每个从库上的，这个过程有⼀个微⼩的时间差，这个时间差叫**主从同步延迟**。正常情况下，主从延迟⾮常⼩，不超过1ms。但即使这个⾮常⼩的延迟，也会导致在某⼀个时刻，主库和从库上的数据是不⼀致的。应⽤程序需要能接受并克服这种主从不⼀致的情况，否则就会引发⼀些由于主从延迟导致的数据错误。

还是拿订单系统来举例，我们⾃然的设计思路是，⽤⼾从购物⻋⾥发起结算创建订单，进⼊订单⻚，打开⽀付⻚⾯进⾏⽀付，⽀付完成后，按道理应该再返回⽀付之前的订单⻚。但如果这个时候⻢上⾃动返回订单

⻚，就很可能会出现订单状态还是显⽰“未⽀付”。因为，⽀付完成后，订单库的主库中，订单状态已经被更新了，⽽订单⻚查询的从库中，这条订单记录的状态有可能还没更新。怎么解决？

这种问题其实没什么好的技术⼿段来解决，所以你看⼤的电商，它⽀付完成后是不会⾃动跳回到订单⻚的，它增加了⼀个⽆关紧要的“⽀付完成”⻚⾯，其实这个⻚⾯没有任何有效的信息，就是告诉你⽀付成功，然后再放⼀些⼴告什么的。你如果想再看刚刚⽀付完成的订单，需要⼿动点⼀下，这样就很好地规避了主从同步延迟的问题。

上⾯这个例⼦还只是订单状态显⽰错误，刷新⼀下就好了。我们需要特别注意的，是那些数据更新后，⽴刻需要查询更新后的数据，然后再更新其他数据这种情况。⽐如说在购物⻋⻚⾯，如果⽤⼾修改了某个商品的数量，需要重新计算优惠和总价。更新了购物⻋的数据后，需要⽴即调⽤计价服务，这个时候如果计价服务去读购物⻋的从库，⾮常可能读到旧数据⽽导致计算的总价错误。

对于这个例⼦，你可以把“更新购物⻋、重新计算总价”这两个步骤合并成⼀个微服务，然后放在⼀个数据库事务中去，同⼀个事务中的查询操作也会被路由到主库，这样来规避主从不⼀致的问题。

对于这种主从延迟带来的数据不⼀致的问题，没有什么简单⽅便⽽且通⽤的技术⽅案可以解决，我们需要重新设计业务逻辑，尽量规避更新数据后⽴即去从库查询刚刚更新的数据。

主从同步延迟会导致主库和从库之间出现数据不⼀致的情况，我们的应⽤程序应该能兼容主从延迟，避免因为主从延迟⽽导致的数据错误。规避这个问题最关键的⼀点是，我们在设计系统的业务流程时，尽量不要在更新数据之后⽴即去查询更新后的数据。



主从同步延迟是必然现象，不是问题。关键看具体业务，因同步延迟带来什么问题，然后再解决。

举个简单的例子

假设某论坛是主从数据库，我发一个帖子后立即刷新页面，因为显示帖子是读，这个时候如果延迟比较厉害，就会提示 404 -———帖子不存在，这就有问题了；我们还要假设用户的容忍度是看见自己的新内容，别人新的内容可以有延迟（实际上延迟是很小的时间单位）。

针对这个假设的问题，可以采取几种方案：
1、有更新数据后的 读取相关数据动作，都从默认到主库；
2、利用缓存；插入新的数据，会有last_id返回，组装成数据，缓存到前端。读取此 id 数据时，先从缓存取。



作者：陆向东
链接：https://www.zhihu.com/question/20025096/answer/13715272
。



1.需要读写强一致性的业务，要强行将读语句路由至Master库



方案：尽量避免写入后立马从数据库读，如果是异步任务，可以延迟个几秒待记录同步到从库后外读。



可以在没读取到数据后，去主库再读一次。

