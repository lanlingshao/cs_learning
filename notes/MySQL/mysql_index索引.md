#### MySQL索引B+树原理

##### 1、使用B+树由来

一般来说，我们使用树来进行**二分查找**，常见的有AVL树和红黑树，但是这两种树适合在内存中进行查询，因为他们虽然查询效率很高，为**logN**，但是他们的**高度**也是logN，如果使用磁盘装数据的话，就要**访问logN次磁盘**。

这样逻辑上很近的节点实际可能非常远，无法很好的利用**磁盘预读（局部性原理）**，所以这类平衡二叉树在数据库和文件系统上的

择就被 pass 了。

```
空间局部性原理：如果一个存储器的某个位置被访问，那么将它附近的位置也会被访问。
```

并且磁盘IO时间很长，与访问内存时间相差了5个数量级，所以效率方面来看，肯定是满足不了要求的。



如果要发挥磁盘的全部特性，软件需要满足的技术特点:

- 一次读取或写入固定大小的一块数据
- 并尽可能减少随机查找这个操作的次数（因为随机查找意味着随机寻道）。
- 我是特意没有写顺序读写这个操作的，因为我认为，只要能做到上面两个条件，那么顺序读写就能够自然而然的做到。

通过上面的两个介绍，你一定会发现，无论ssd还是磁盘，他们都有一个共性的要求是，一次读写**固定大小的一块数据**。

不知道这时候大家会不会立刻联想到一个数据结构？对，就是**数组**。 数组的特性就是拥有固定的大小。

有序数组有一个最大的难点就在于如何能够让数组以更便宜的方式来实现**数组的自动扩展**。

因为数组的大小是固定的，那么如果想扩展怎么办呢？

一种能够想到的方式是，每次满了就创建一个新数组，然后数据全复制到新数组中 。但这样做有个很大的问题，是每一次都需要做一次数据的全拷贝，代价相对比较大。

另外一种方式是，保持数组大小不变，但增加数组的个数，不是也可以增加整个数据结构承载数据的总量么？

 这个思路就是b树的核心思路，

由于二叉树查找无法满足磁盘查询的性能要求， 这个时候B+树应运而生，**B+树查询的效率也是logN**，但是**高度却很低**，一般2-3层就可以了。

[b+树的索引数据在磁盘中的查找过程](https://www.cnblogs.com/myseries/p/12532919.html)

##### 2、B+树特性

那么b树的核心是几个关键词

1. **树高**: 一般来说，树的高度要比二叉平衡树低很多

2. **数组**: 每一个node，都是一个“数组”，数组是很关键的决定性因素，因为**顺序数组**可以进行**二分查找**。

3.   **数据**：只出现在**叶子**节点，非叶子结点只存放指针，这样非叶子结点就可以存放更多指针，相对于B树，B+树高又可以进一步降低

4.   **顺序指针**：所有叶子节点增加了一个链指针，这样有利于进行范围查找，因为只需要遍历链表即可。



#### MySQL所以为什么使用B+树，而MongoDB为什么使用B树？

B+树是B-树的变种，它与B-树的不同之处在于：

- 在B+树中，key 的副本存储在内部节点，真正的 key 和 data 存储在叶子节点上 。
- n 个 key 值的节点指针域为 n 而不是 n+1。

因为内节点并不存储 data，所以一般B+树的叶节点和内节点大小不同，而B-树的每个节点大小一般是相同的，为一页。

##### B-树和B+树的区别

1. B+树内节点不存储数据，所有 data 存储在叶节点导致查询时间复杂度固定为 log n。而B-树查询时间复杂度不固定，与 key 在树中的位置有关，最好为O(1)。
2. B+树叶节点两两相连可大大增加区间访问性，可使用在范围查询等，而B-树每个节点 key 和 data 在一起，则无法区间查找。
3. B+树更适合外部存储。由于内节点无 data 域，每个节点能索引的范围更大更精确

B+树可以很好的利用**局部性原理**，若我们访问节点 key为 50，则 key 为 55、60、62 的节点将来也可能被访问，我们可以利用磁盘预读原理提前将这些数据读入内存，减少了磁盘 IO 的次数。 
当然B+树也能够很好的完成范围查询。比如查询 key 值在 50-70 之间的节点。

##### 为什么 MongoDB 使用B-树(现在mongo改为使用wiredTiger引擎，用的是B+树了)

MongoDB 是一种 nosql，也存储在磁盘上，被设计用在 数据模型简单，性能要求高的场合。性能要求高，看看B/B+树的区别第一点：

> B+树内节点不存储数据，所有 data 存储在叶节点导致查询时间复杂度固定为 log n。而B-树查询时间复杂度不固定，与 key 在树中的位置有关，最好为O(1)

我们说过，尽可能少的磁盘 IO 是提高性能的有效手段。MongoDB 是聚合型数据库，而 B-树恰好 key 和 data 域聚合在一起。

##### 为什么 Mysql 使用B+树

Mysql 是一种关系型数据库，区间访问是常见的一种情况，而 B-树并不支持区间访问，而B+树由于数据全部存储在叶子节点，并且通过指针串在一起，这样就很容易的进行区间遍历甚至全部遍历。

见B/B+树的区别第二点：

> B+树叶节点两两相连可大大增加区间访问性，可使用在范围查询等，而B-树每个节点 key 和 data 在一起，则无法区间查找。

其次B+树的查询效率更加**稳定**，数据全部存储在叶子节点，查询时间复杂度固定为 O(log n)。

最后第三点：

> B+树更适合外部存储。由于内节点无 data 域，每个节点能索引的范围更大更精确

[为什么 MongoDB （索引）使用B-树而 Mysql 使用 B+树](https://www.cnblogs.com/kaleidoscope/p/9481991.html)

[为什么Mongodb索引用B树，而Mysql用B+树?](https://www.cnblogs.com/rjzheng/p/12316685.html)
