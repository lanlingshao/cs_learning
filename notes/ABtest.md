### AB实验设计与实践

#### AB实验

为同一个目标制定两个方案（比如两个页面），将产品的用户流量随机分割成 A/B 两组，一组实验组，一组对照组，两组实验同时运行一段时间后分别统计两组用户的表现，再将相关结果数据（比如pv/uv、商机转化率等）进行对比，就可以科学地帮助决策。比如在这个例子里，50%用户看到 A 版本页面，50%用户看到 B 版本页面，经过一段时间的观察后，统计发现A 版本用户转化率 30%，高于 B 版本的 20%，如此，我们就可以判定 A 版本胜出，然后将 A 版本页面推送给所有的用户。

通常网站会利用**分域**、**分层**、**分桶**的机制保证流量高可用以及分流的灵活性和科学性。这样做的原因有以下几点：

   （1）AB实验大多数情况下是在一定场景下进行的，我们只需要选择对应场景的流量即可，做到流量合理划分。比如某个新功能在某个城市上线，那我们的实验流量肯定是选择这个城市的用户，比如北京用户。这里就需要按照城市维度划分单个流量域，在这个流量域内进行新功能的实验。

   （2）流量是有限的，但是实验的数量是可以无限扩展的。试想如果我们在链家网选择北京这个城市后，针对北京房源列表页展示做了实验一列表展示优化实验，实验二推荐算法对比实验，还有其他实验等。如果不分层，北京用户这部分流量，实验一占了60%，实验二最多只能占到40%，再来其他实验，只能被分到更少的流量。因此会产生实验流量饥饿的问题。在做了分层之后，每层实验之间流量互不干扰，共享100%的流量，流量在每一层被重新打散分配。就可以支持更多的实验同时运行而不会导致流量饥饿的问题。

   （3）实验的对照组和实验组之间是流量互斥的，因此需要分桶隔离，将流量随机分到不同的桶中。

#### 分层实验模型

作为实验平台，支持同时运行大量AB实验是其基本要求。多实验并行的情况下，我们根据共享同一份流量情况下，两个实验效果是否会产生干扰，将实验之间的关系分为正交实验和互斥实验。

- **互斥实验**：如果分层共享同一份流量就有可能出现实验效果之间相互干扰的问题，这样的实验叫互斥实验，也就是如果实验一和实验二是互斥关系，那么经过实验一的流量就不能进入到实验二。

- **正交实验**：如果实验之间共享同一份流量实验效果之间不干扰，这样的实验我们叫正交实验，这种情况下，流经两个实验的流量是可以共享的，流经实验一的流量也可以流经实验二。

举个栗子：例如实验一是web页面背景色，实验二是文字颜色，实验一的对照实验是蓝色，实验二的对照实验也是蓝色，那么如果实验一和实验二共享同一份流量，那么这部分流量就会出现一种背景色为蓝色，文字为蓝色的情况，这样的页面是不可读的，两个实验的效果就产生了干扰，这里的实验一和实验二就是互斥实验。另假设，这里实验一不变，实验二是列表页推荐算法的优化，那么页面的背景色展示和算法优化就可以共享同一份流量，经过实验一的流量到实验二的时候被重新随机打散。实验效果之间并不会产生干扰，将这样的实验我们称之为正交实验。后文还会详细讲模型如何处理这两种实验。

多实验并行过程中，既有正交实验，也有互斥实验并且要保证流量在实验过程中科学合理的分配。分层实验模型就提出了“层”的概念。层的原则是：同一层存在多个互斥实验，流量流经该层最多可以参与一个实验。层与层之间，流量是正交的，也就是说流量在穿越每一层实验时候，都会被再次随机打散，经过上层实验一的流量可能会经过下层的任何一个实 验，可能是实验一，也可能是实验二

#### 流量分桶

模型有了，怎么分流也很重要，那么什么是分流呢？分流指的是是根据分流算法策略为每层的每个实验分配相应的流量，从请求角度来说，是让每个请求都能在各层都能准确稳定的命中到相应实验。分流也叫流量分桶，为什么叫流量分桶呢？那首先就得说明一下这里的桶指的是什么。

这里，每一层的每个实验的实验组和对照组就是一个桶，每层的流量一共是100，假设这一层有两个实验分别是实验一和实验二，流量配比各为50%，每个实验各有一实验组和对照组，实验组和对照组平分流量各得25%，那么这里每层实验就有4个桶。整体流量按桶划分，从0开始编号的话，可以认为，实验一组一的桶装的是024的编号，实验一组二的桶装的是2549编号，类推，实验二组二的桶装的是75~99的编号。一个流量请求在每一层中只能命中到一个实验组，也就是说只能被分到一个桶内。一般我们会选择用用户id和实验层id哈希取模（mod=f(uid, layer)%100），得到的值在哪个桶内，该请求就命中哪个实验的那个组,这样 保证了用户在每层命中的实验是随机且是稳定的。

参考[Athena-贝壳流量实验平台设计与实践](https://www.jianshu.com/p/79d31a72978f)

[美团点评效果广告实验配置平台的设计与实现](https://tech.meituan.com/2019/11/28/advertising-performance-experiment-configuration-platform.html)

